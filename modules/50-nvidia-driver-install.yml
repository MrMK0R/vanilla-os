name: nvidia-official-driver
type: shell
commands:
- apt-mark hold nvidia-kernel-open nvidia-driver nvidia-vaapi-driver nvidia-settings nvidia-persistenced nvidia-smi libnvidia-cfg1 libnvidia-glcore libnvidia-glvkspirv libnvidia-gpucomp libnvidia-fbc1 nvidia-container-toolkit

modules:
- name: install-nvidia
  type: apt
  source:
    packages:
    - nvidia-kernel-open
    - nvidia-driver
    - nvidia-vaapi-driver
    - nvidia-settings
    - nvidia-persistenced
    - cuda-drivers
    - libnvidia-cfg1
    - libnvidia-glcore
    - libnvidia-glvkspirv
    - libnvidia-gpucomp
    - libnvidia-fbc1
    - nvidia-container-toolkit
    
  modules:
    - name: nvidia-official-repo
      type: shell
      commands:
        # download the 580.65.06 runfile
        - curl -fSL https://us.download.nvidia.com/XFree86/Linux-x86_64/580.65.06/NVIDIA-Linux-x86_64-580.65.06.run \
          -o /tmp/NVIDIA-580.65.06.run
        # make it executable
        - chmod +x /tmp/NVIDIA-580.65.06.run
        # install silently, without kernel module rebuild (Docker images usually use the host kernel)
        - /tmp/NVIDIA-580.65.06.run --silent --no-kernel-module
        # clean up
        - rm /tmp/NVIDIA-580.65.06.run
        # hold the installed packages (the runfile creates nvidia-driver, nvidia-utils, etc.)
        - apt-mark hold nvidia-driver nvidia-utils nvidia-smi libnvidia-glcore libnvidia-glvkspirv \
          libnvidia-cfg1 libnvidia-fbc1 libnvidia-gpucomp


